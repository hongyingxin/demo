<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Threshold 阈值详解 Demo</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    .demo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 30px;
    }

    .demo-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .demo-section h2 {
      margin: 0 0 15px 0;
      color: #4CAF50;
      font-size: 20px;
      text-align: center;
    }

    .threshold-value {
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    .scroll-area {
      height: 300px;
      overflow-y: auto;
      border: 2px solid #ddd;
      background: #fafafa;
      position: relative;
      border-radius: 4px;
    }

    /* 视口指示器 */
    .viewport-indicator {
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      border: 3px dashed #2196F3;
      background: rgba(33, 150, 243, 0.05);
      pointer-events: none;
      z-index: 1;
    }

    .viewport-label {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #2196F3;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    /* 目标元素 */
    .target-element {
      width: 80%;
      height: 200px;
      margin: 400px auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      position: relative;
      transition: all 0.3s ease;
    }

    .target-element.triggered {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .visibility-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(76, 175, 80, 0.8);
      transition: height 0.1s ease;
      border-radius: 0 0 8px 8px;
    }

    .visibility-text {
      font-size: 24px;
      z-index: 1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .trigger-status {
      font-size: 14px;
      margin-top: 10px;
      z-index: 1;
    }

    /* 说明区域 */
    .explanation {
      margin-top: 40px;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .explanation h2 {
      color: #333;
      margin-bottom: 20px;
    }

    .threshold-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .threshold-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }

    .threshold-item strong {
      color: #4CAF50;
      font-size: 18px;
    }

    .threshold-item p {
      margin: 10px 0 0 0;
      color: #666;
      font-size: 14px;
      line-height: 1.5;
    }

    /* 多阈值演示 */
    .multi-threshold-demo {
      margin-top: 40px;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .events-log {
      margin-top: 20px;
      padding: 15px;
      background: #2d3436;
      color: #dfe6e9;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      background: rgba(255,255,255,0.05);
      border-radius: 2px;
    }

    .log-threshold {
      color: #4CAF50;
      font-weight: bold;
    }

    .log-direction {
      color: #74b9ff;
    }

    /* 提示 */
    .tip {
      margin: 20px 0;
      padding: 15px;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Intersection Observer Threshold（阈值）详解</h1>
    
    <div class="tip">
      💡 <strong>重要概念：</strong>threshold 表示元素的<strong>可见比例</strong>，而不是消失比例！
      向下滚动查看不同阈值的触发时机。
    </div>

    <!-- 三个独立的演示 -->
    <div class="demo-grid">
      <!-- Threshold = 0 -->
      <div class="demo-section">
        <h2>Threshold = 0</h2>
        <div class="threshold-value">0</div>
        <div class="scroll-area" id="scroll1">
          <div class="viewport-indicator">
            <div class="viewport-label">视口区域</div>
          </div>
          <div class="target-element" id="target1">
            <div class="visibility-bar" id="bar1"></div>
            <div class="visibility-text">可见: <span id="ratio1">0%</span></div>
            <div class="trigger-status" id="status1">等待触发...</div>
          </div>
        </div>
        <p style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;">
          元素刚出现一个像素就触发
        </p>
      </div>

      <!-- Threshold = 0.5 -->
      <div class="demo-section">
        <h2>Threshold = 0.5</h2>
        <div class="threshold-value">0.5</div>
        <div class="scroll-area" id="scroll2">
          <div class="viewport-indicator">
            <div class="viewport-label">视口区域</div>
          </div>
          <div class="target-element" id="target2">
            <div class="visibility-bar" id="bar2"></div>
            <div class="visibility-text">可见: <span id="ratio2">0%</span></div>
            <div class="trigger-status" id="status2">等待触发...</div>
          </div>
        </div>
        <p style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;">
          元素显示50%时触发
        </p>
      </div>

      <!-- Threshold = 1.0 -->
      <div class="demo-section">
        <h2>Threshold = 1.0</h2>
        <div class="threshold-value">1.0</div>
        <div class="scroll-area" id="scroll3">
          <div class="viewport-indicator">
            <div class="viewport-label">视口区域</div>
          </div>
          <div class="target-element" id="target3">
            <div class="visibility-bar" id="bar3"></div>
            <div class="visibility-text">可见: <span id="ratio3">0%</span></div>
            <div class="trigger-status" id="status3">等待触发...</div>
          </div>
        </div>
        <p style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;">
          元素100%完全显示时触发
        </p>
      </div>
    </div>

    <!-- 详细说明 -->
    <div class="explanation">
      <h2>📖 Threshold 详细说明</h2>
      
      <div class="threshold-list">
        <div class="threshold-item">
          <strong>threshold: 0</strong>
          <p>
            当目标元素与根元素（视口）有任何交集时触发。<br>
            即使只有1个像素进入视口也会触发回调。<br>
            常用于：懒加载、无限滚动等。
          </p>
        </div>
        
        <div class="threshold-item">
          <strong>threshold: 0.5</strong>
          <p>
            当目标元素有50%面积进入视口时触发。<br>
            元素一半可见时执行回调。<br>
            常用于：动画触发、数据统计等。
          </p>
        </div>
        
        <div class="threshold-item">
          <strong>threshold: 1.0</strong>
          <p>
            当目标元素100%完全进入视口时触发。<br>
            整个元素都在视口内才执行回调。<br>
            常用于：确保元素完全可见的场景。
          </p>
        </div>
        
        <div class="threshold-item">
          <strong>threshold: [0, 0.25, 0.5, 0.75, 1]</strong>
          <p>
            可以设置多个阈值，分别在0%、25%、50%、75%、100%时触发。<br>
            用于需要精确追踪可见度变化的场景。
          </p>
        </div>
      </div>
    </div>

    <!-- 多阈值演示 -->
    <div class="multi-threshold-demo">
      <h2>🎯 多阈值演示</h2>
      <p>这个演示使用了多个阈值：[0, 0.25, 0.5, 0.75, 1]</p>
      
      <div class="scroll-area" style="height: 400px;" id="scroll4">
        <div class="viewport-indicator">
          <div class="viewport-label">视口区域</div>
        </div>
        <div class="target-element" id="target4" style="height: 300px;">
          <div class="visibility-bar" id="bar4"></div>
          <div class="visibility-text" style="font-size: 36px;">可见: <span id="ratio4">0%</span></div>
          <div class="trigger-status" id="status4">等待触发...</div>
        </div>
      </div>
      
      <div class="events-log" id="eventsLog">
        <div style="font-weight: bold; margin-bottom: 10px;">📋 事件日志（多阈值）</div>
      </div>
    </div>
  </div>

  <script>
    // 创建三个独立的观察器
    function createDemo(scrollId, targetId, barId, ratioId, statusId, threshold) {
      const scrollContainer = document.getElementById(scrollId);
      const target = document.getElementById(targetId);
      const bar = document.getElementById(barId);
      const ratioDisplay = document.getElementById(ratioId);
      const statusDisplay = document.getElementById(statusId);
      
      let hasTriggered = false;
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const ratio = entry.intersectionRatio;
          const percentage = (ratio * 100).toFixed(1);
          
          // 更新可见度条
          bar.style.height = `${ratio * 100}%`;
          
          // 更新可见度文本
          ratioDisplay.textContent = `${percentage}%`;
          
          // 检查是否达到阈值
          if (ratio >= threshold && !hasTriggered) {
            hasTriggered = true;
            target.classList.add('triggered');
            statusDisplay.textContent = '✅ 已触发！';
            statusDisplay.style.color = '#4CAF50';
          } else if (ratio < threshold && hasTriggered) {
            hasTriggered = false;
            target.classList.remove('triggered');
            statusDisplay.textContent = '等待触发...';
            statusDisplay.style.color = 'white';
          }
        });
      }, {
        root: scrollContainer,
        threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1] // 使用多个阈值以获得平滑更新
      });
      
      observer.observe(target);
    }

    // 创建多阈值演示
    function createMultiThresholdDemo() {
      const scrollContainer = document.getElementById('scroll4');
      const target = document.getElementById('target4');
      const bar = document.getElementById('bar4');
      const ratioDisplay = document.getElementById('ratio4');
      const statusDisplay = document.getElementById('status4');
      const eventsLog = document.getElementById('eventsLog');
      
      const thresholds = [0, 0.25, 0.5, 0.75, 1];
      let lastCrossedThreshold = -1;
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const ratio = entry.intersectionRatio;
          const percentage = (ratio * 100).toFixed(1);
          
          // 更新可见度条
          bar.style.height = `${ratio * 100}%`;
          
          // 更新可见度文本
          ratioDisplay.textContent = `${percentage}%`;
          
          // 检查跨越的阈值
          thresholds.forEach((threshold, index) => {
            if (ratio >= threshold && lastCrossedThreshold < index) {
              // 向上跨越阈值
              lastCrossedThreshold = index;
              addLog(`向上跨越阈值 ${threshold} (${threshold * 100}%)`, 'up');
              target.classList.add('triggered');
              statusDisplay.textContent = `当前跨越: ${threshold * 100}%`;
            } else if (ratio < threshold && lastCrossedThreshold >= index) {
              // 向下跨越阈值
              if (ratio < thresholds[lastCrossedThreshold]) {
                lastCrossedThreshold = index - 1;
                addLog(`向下跨越阈值 ${threshold} (${threshold * 100}%)`, 'down');
                if (lastCrossedThreshold < 0) {
                  target.classList.remove('triggered');
                  statusDisplay.textContent = '等待触发...';
                } else {
                  statusDisplay.textContent = `当前跨越: ${thresholds[lastCrossedThreshold] * 100}%`;
                }
              }
            }
          });
        });
      }, {
        root: scrollContainer,
        threshold: thresholds
      });
      
      observer.observe(target);
      
      function addLog(message, direction) {
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
          ${time} - 
          <span class="log-direction">${direction === 'up' ? '📈' : '📉'}</span> 
          ${message}
        `;
        
        eventsLog.insertBefore(entry, eventsLog.children[1]);
        
        // 限制日志数量
        while (eventsLog.children.length > 10) {
          eventsLog.removeChild(eventsLog.lastChild);
        }
      }
    }

    // 初始化所有演示
    createDemo('scroll1', 'target1', 'bar1', 'ratio1', 'status1', 0);
    createDemo('scroll2', 'target2', 'bar2', 'ratio2', 'status2', 0.5);
    createDemo('scroll3', 'target3', 'bar3', 'ratio3', 'status3', 1.0);
    createMultiThresholdDemo();
  </script>
</body>
</html>
