<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— é™æ»šåŠ¨åŠ è½½ - åŸç”Ÿå®ç°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .status-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-info span {
            font-weight: bold;
            color: #1976d2;
        }

        .list-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .list-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .list-item:hover {
            background-color: #f8f9fa;
        }

        .list-item h3 {
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .list-item p {
            color: #7f8c8d;
            line-height: 1.6;
        }

        .list-item .meta {
            margin-top: 10px;
            font-size: 12px;
            color: #95a5a6;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading-spinner {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“¨å…µå…ƒç´  */
        .sentinel {
            height: 1px;
            margin-top: 20px;
        }

        /* åŠ è½½å®Œæˆæç¤º */
        .end-message {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
            display: none;
        }

        .end-message.active {
            display: block;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background-color: #fee;
            border-radius: 4px;
            margin: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* è°ƒè¯•ä¿¡æ¯ */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
        }

        .debug-panel h4 {
            margin-bottom: 10px;
        }

        .debug-panel div {
            margin: 5px 0;
        }

        .debug-panel .label {
            display: inline-block;
            width: 120px;
            color: #64b5f6;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .controls button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #2980b9;
        }

        .controls button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ— é™æ»šåŠ¨åŠ è½½ç¤ºä¾‹</h1>
        
        <div class="status-info">
            <div>æ£€æµ‹æ–¹å¼ï¼š<span id="detection-method">åˆå§‹åŒ–ä¸­...</span></div>
            <div>å·²åŠ è½½é¡¹ç›®ï¼š<span id="loaded-count">0</span> ä¸ª</div>
            <div>æ€»é¡¹ç›®æ•°ï¼š<span id="total-count">100</span> ä¸ª</div>
        </div>

        <div class="controls">
            <button id="reset-btn">é‡ç½®åˆ—è¡¨</button>
            <button id="toggle-debug">åˆ‡æ¢è°ƒè¯•é¢æ¿</button>
            <button id="simulate-fast-scroll">æ¨¡æ‹Ÿå¿«é€Ÿæ»šåŠ¨</button>
        </div>

        <div class="list-container" id="list-container">
            <div id="list-content"></div>
            
            <!-- åŠ è½½ä¸­æç¤º -->
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
            
            <!-- å“¨å…µå…ƒç´  -->
            <div class="sentinel" id="sentinel"></div>
            
            <!-- åŠ è½½å®Œæˆæç¤º -->
            <div class="end-message" id="end-message">
                <p>ğŸ‰ æ‰€æœ‰å†…å®¹å·²åŠ è½½å®Œæˆ</p>
            </div>
            
            <!-- é”™è¯¯æç¤º -->
            <div class="error-message" id="error-message">
                <p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel" id="debug-panel" style="display: none;">
        <h4>è°ƒè¯•ä¿¡æ¯</h4>
        <div><span class="label">ObserverçŠ¶æ€:</span><span id="observer-status">-</span></div>
        <div><span class="label">æ»šåŠ¨ç›‘å¬çŠ¶æ€:</span><span id="scroll-status">-</span></div>
        <div><span class="label">è§¦å‘æ¬¡æ•°:</span><span id="trigger-count">0</span></div>
        <div><span class="label">æ»šåŠ¨ä½ç½®:</span><span id="scroll-position">-</span></div>
        <div><span class="label">è·ç¦»åº•éƒ¨:</span><span id="distance-to-bottom">-</span></div>
    </div>

    <script>
        // é…ç½®å‚æ•°
        const CONFIG = {
            pageSize: 10,              // æ¯é¡µåŠ è½½æ•°é‡
            totalItems: 100,           // æ€»æ•°æ®é‡
            loadDelay: 1000,           // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
            scrollThreshold: 100,      // æ»šåŠ¨è§¦å‘é˜ˆå€¼ï¼ˆè·ç¦»åº•éƒ¨åƒç´ ï¼‰
            observerThreshold: 0.1,    // IntersectionObserver è§¦å‘é˜ˆå€¼
            useObserver: true,         // æ˜¯å¦ä½¿ç”¨ IntersectionObserver
            useScrollFallback: true,   // æ˜¯å¦å¯ç”¨æ»šåŠ¨äº‹ä»¶ä½œä¸ºå¤‡ç”¨
            debugMode: false,          // è°ƒè¯•æ¨¡å¼
            throttleDelay: 200         // æ»šåŠ¨äº‹ä»¶èŠ‚æµå»¶è¿Ÿ
        };

        // åº”ç”¨çŠ¶æ€
        const state = {
            currentPage: 0,
            loadedItems: 0,
            isLoading: false,
            hasMore: true,
            observer: null,
            triggerCount: 0,
            lastTriggerSource: null
        };

        // DOM å…ƒç´ 
        const elements = {
            listContent: document.getElementById('list-content'),
            loadingSpinner: document.getElementById('loading-spinner'),
            sentinel: document.getElementById('sentinel'),
            endMessage: document.getElementById('end-message'),
            errorMessage: document.getElementById('error-message'),
            listContainer: document.getElementById('list-container'),
            // çŠ¶æ€æ˜¾ç¤º
            detectionMethod: document.getElementById('detection-method'),
            loadedCount: document.getElementById('loaded-count'),
            totalCount: document.getElementById('total-count'),
            // è°ƒè¯•é¢æ¿
            debugPanel: document.getElementById('debug-panel'),
            observerStatus: document.getElementById('observer-status'),
            scrollStatus: document.getElementById('scroll-status'),
            triggerCount: document.getElementById('trigger-count'),
            scrollPosition: document.getElementById('scroll-position'),
            distanceToBottom: document.getElementById('distance-to-bottom')
        };

        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
        function generateMockData(page, pageSize) {
            const items = [];
            const start = page * pageSize;
            const end = Math.min(start + pageSize, CONFIG.totalItems);
            
            for (let i = start; i < end; i++) {
                items.push({
                    id: i + 1,
                    title: `é¡¹ç›® ${i + 1}`,
                    description: `è¿™æ˜¯ç¬¬ ${i + 1} ä¸ªé¡¹ç›®çš„æè¿°å†…å®¹ã€‚è¿™é‡Œå¯ä»¥åŒ…å«æ›´å¤šçš„ä¿¡æ¯ï¼Œè®©åˆ—è¡¨çœ‹èµ·æ¥æ›´çœŸå®ã€‚`,
                    time: new Date().toLocaleString(),
                    category: ['æŠ€æœ¯', 'ç”Ÿæ´»', 'å·¥ä½œ', 'å­¦ä¹ '][Math.floor(Math.random() * 4)]
                });
            }
            
            return items;
        }

        // æ¸²æŸ“åˆ—è¡¨é¡¹
        function renderItems(items) {
            const fragment = document.createDocumentFragment();
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <div class="meta">
                        <span>åˆ†ç±»: ${item.category}</span> | 
                        <span>æ—¶é—´: ${item.time}</span>
                    </div>
                `;
                fragment.appendChild(div);
            });
            
            elements.listContent.appendChild(fragment);
        }

        // åŠ è½½æ›´å¤šæ•°æ®
        async function loadMore(source = 'unknown') {
            if (state.isLoading || !state.hasMore) {
                console.log('è·³è¿‡åŠ è½½ï¼š', state.isLoading ? 'æ­£åœ¨åŠ è½½ä¸­' : 'æ²¡æœ‰æ›´å¤šæ•°æ®');
                return;
            }
            
            state.isLoading = true;
            state.lastTriggerSource = source;
            state.triggerCount++;
            updateDebugInfo();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            elements.loadingSpinner.classList.add('active');
            elements.errorMessage.classList.remove('active');
            
            try {
                // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
                await new Promise(resolve => setTimeout(resolve, CONFIG.loadDelay));
                
                // è·å–æ•°æ®
                const items = generateMockData(state.currentPage, CONFIG.pageSize);
                
                if (items.length > 0) {
                    renderItems(items);
                    state.currentPage++;
                    state.loadedItems += items.length;
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    elements.loadedCount.textContent = state.loadedItems;
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
                    if (state.loadedItems >= CONFIG.totalItems) {
                        state.hasMore = false;
                        elements.endMessage.classList.add('active');
                        elements.sentinel.style.display = 'none';
                    }
                } else {
                    state.hasMore = false;
                    elements.endMessage.classList.add('active');
                }
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                elements.errorMessage.classList.add('active');
            } finally {
                state.isLoading = false;
                elements.loadingSpinner.classList.remove('active');
                updateDebugInfo();
            }
        }

        // èŠ‚æµå‡½æ•°
        function throttle(func, delay) {
            let timeoutId;
            let lastExecTime = 0;
            
            return function (...args) {
                const currentTime = Date.now();
                
                if (currentTime - lastExecTime > delay) {
                    func.apply(this, args);
                    lastExecTime = currentTime;
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                        lastExecTime = Date.now();
                    }, delay - (currentTime - lastExecTime));
                }
            };
        }

        // æ£€æŸ¥æ»šåŠ¨ä½ç½®
        function checkScrollPosition() {
            const scrollTop = elements.listContainer.scrollTop;
            const scrollHeight = elements.listContainer.scrollHeight;
            const clientHeight = elements.listContainer.clientHeight;
            const distanceToBottom = scrollHeight - scrollTop - clientHeight;
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯ï¼ˆå§‹ç»ˆæ›´æ–°ï¼Œä½†åªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
            elements.scrollPosition.textContent = `${Math.round(scrollTop)}px`;
            elements.distanceToBottom.textContent = `${Math.round(distanceToBottom)}px`;
            
            // å½“è·ç¦»åº•éƒ¨å°äºé˜ˆå€¼æ—¶åŠ è½½æ›´å¤š
            if (distanceToBottom < CONFIG.scrollThreshold) {
                loadMore('scroll');
            }
        }

        // èŠ‚æµåçš„æ»šåŠ¨å¤„ç†å‡½æ•°
        const throttledScrollHandler = throttle(checkScrollPosition, CONFIG.throttleDelay);

        // è®¾ç½® IntersectionObserver
        function setupIntersectionObserver() {
            if (!('IntersectionObserver' in window) || !CONFIG.useObserver) {
                console.log('IntersectionObserver ä¸å¯ç”¨æˆ–å·²ç¦ç”¨');
                elements.observerStatus.textContent = 'ä¸å¯ç”¨';
                return false;
            }
            
            const options = {
                root: elements.listContainer,
                rootMargin: `0px 0px ${CONFIG.scrollThreshold}px 0px`,
                threshold: CONFIG.observerThreshold
            };
            
            state.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        console.log('IntersectionObserver è§¦å‘');
                        loadMore('observer');
                    }
                });
            }, options);
            
            state.observer.observe(elements.sentinel);
            elements.observerStatus.textContent = 'å·²å¯ç”¨';
            return true;
        }

        // è®¾ç½®æ»šåŠ¨ç›‘å¬
        function setupScrollListener() {
            if (!CONFIG.useScrollFallback) {
                elements.scrollStatus.textContent = 'å·²ç¦ç”¨';
                return;
            }
            
            elements.listContainer.addEventListener('scroll', throttledScrollHandler, { passive: true });
            elements.scrollStatus.textContent = 'å·²å¯ç”¨';
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            if (!CONFIG.debugMode) return;
            
            elements.triggerCount.textContent = state.triggerCount;
            
            // æ›´æ–°æ£€æµ‹æ–¹å¼æ˜¾ç¤º
            let method = [];
            if (state.observer) method.push('IntersectionObserver');
            if (CONFIG.useScrollFallback) method.push('æ»šåŠ¨äº‹ä»¶');
            elements.detectionMethod.textContent = method.join(' + ') || 'æ— ';
        }

        // é‡ç½®åˆ—è¡¨
        function resetList() {
            // æ¸…ç©ºåˆ—è¡¨
            elements.listContent.innerHTML = '';
            
            // é‡ç½®çŠ¶æ€
            state.currentPage = 0;
            state.loadedItems = 0;
            state.isLoading = false;
            state.hasMore = true;
            state.triggerCount = 0;
            
            // é‡ç½®UI
            elements.endMessage.classList.remove('active');
            elements.errorMessage.classList.remove('active');
            elements.sentinel.style.display = 'block';
            elements.loadedCount.textContent = '0';
            
            // é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
            loadMore('reset');
        }

        // æ¨¡æ‹Ÿå¿«é€Ÿæ»šåŠ¨
        function simulateFastScroll() {
            const scrollHeight = elements.listContainer.scrollHeight;
            const duration = 500; // 500ms å†…æ»šåŠ¨åˆ°åº•éƒ¨
            const start = elements.listContainer.scrollTop;
            const distance = scrollHeight - start - elements.listContainer.clientHeight;
            const startTime = performance.now();
            
            function scrollAnimation(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                elements.listContainer.scrollTop = start + distance * progress;
                
                if (progress < 1) {
                    requestAnimationFrame(scrollAnimation);
                }
            }
            
            requestAnimationFrame(scrollAnimation);
        }

        // åˆå§‹åŒ–
        function init() {
            // è®¾ç½®æ€»æ•°
            elements.totalCount.textContent = CONFIG.totalItems;
            
            // è®¾ç½® IntersectionObserver
            const observerEnabled = setupIntersectionObserver();
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬
            setupScrollListener();
            
            // ç»‘å®šæ§åˆ¶æŒ‰é’®
            document.getElementById('reset-btn').addEventListener('click', resetList);
            document.getElementById('toggle-debug').addEventListener('click', () => {
                CONFIG.debugMode = !CONFIG.debugMode;
                elements.debugPanel.style.display = CONFIG.debugMode ? 'block' : 'none';
                updateDebugInfo();
                checkScrollPosition(); // ç«‹å³æ›´æ–°æ»šåŠ¨ä½ç½®ä¿¡æ¯
            });
            document.getElementById('simulate-fast-scroll').addEventListener('click', simulateFastScroll);
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadMore('init');
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();
            
            // åˆå§‹åŒ–æ»šåŠ¨ä½ç½®ä¿¡æ¯
            checkScrollPosition();
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>
