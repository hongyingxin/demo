<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç”Ÿ DOM è½¬ Canvas å®ç° - æ— éœ€æ’ä»¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .panel h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .image-upload {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .image-upload input {
            display: none;
        }

        /* æµ·æŠ¥å†…å®¹æ ·å¼ */
        #posterContent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 40px;
            color: white;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }

        #posterImage {
            width: 100%;
            height: 250px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #posterImage img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #posterTitle {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        #posterSubtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .poster-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.2);
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        #previewArea {
            min-height: 200px;
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading {
            font-size: 1.5em;
            color: #667eea;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-box {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-box ul {
            list-style: none;
            color: #4a5568;
        }

        .info-box li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box li:before {
            content: "âœ“";
            color: #48bb78;
            font-weight: bold;
        }

        .tech-stack {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .tech-stack h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .tech-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tech-tag {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ åŸç”Ÿ DOM è½¬ Canvas</h1>
            <p>ä¸ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œçº¯åŸç”Ÿ JavaScript å®ç°</p>
            <span class="badge">é›¶ä¾èµ– Â· è½»é‡çº§</span>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šç¼–è¾‘åŒº -->
            <div class="panel">
                <h2>ğŸ“ ç¼–è¾‘æµ·æŠ¥</h2>

                <div class="form-group">
                    <label for="titleInput">ä¸»æ ‡é¢˜</label>
                    <input type="text" id="titleInput" placeholder="è¾“å…¥ä¸»æ ‡é¢˜" 
                           value="åŸç”ŸæŠ€æœ¯å®ç°" oninput="updatePoster()">
                </div>

                <div class="form-group">
                    <label for="subtitleInput">å‰¯æ ‡é¢˜</label>
                    <input type="text" id="subtitleInput" placeholder="è¾“å…¥å‰¯æ ‡é¢˜" 
                           value="DOM â†’ Canvas â†’ Image" oninput="updatePoster()">
                </div>

                <div class="form-group">
                    <label for="watermarkInput">æ°´å°æ–‡æœ¬</label>
                    <input type="text" id="watermarkInput" placeholder="è¾“å…¥æ°´å°æ–‡æœ¬" 
                           value="@YourBrand">
                </div>

                <div class="form-group">
                    <label for="watermarkType">æ°´å°ç±»å‹</label>
                    <select id="watermarkType">
                        <option value="none">æ— æ°´å°</option>
                        <option value="single">å•ä¸ªæ°´å°</option>
                        <option value="tiled" selected>å¹³é“ºæ°´å°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="watermarkPosition">æ°´å°ä½ç½®ï¼ˆå•ä¸ªæ°´å°ï¼‰</label>
                    <select id="watermarkPosition">
                        <option value="bottom-right" selected>å³ä¸‹è§’</option>
                        <option value="bottom-left">å·¦ä¸‹è§’</option>
                        <option value="top-right">å³ä¸Šè§’</option>
                        <option value="top-left">å·¦ä¸Šè§’</option>
                        <option value="center">å±…ä¸­</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡</label>
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
                        <div>ğŸ“¸ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                        <div style="font-size: 0.9em; color: #718096; margin-top: 10px;">æ”¯æŒ JPGã€PNGã€GIF</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generatePoster()">
                    ğŸ¨ ç”Ÿæˆæµ·æŠ¥
                </button>

                <button class="btn btn-success" id="downloadBtn" onclick="downloadPoster()" disabled>
                    ğŸ“¥ ä¸‹è½½æµ·æŠ¥
                </button>

                <div class="info-box">
                    <h3>ğŸš€ æŠ€æœ¯ç‰¹ç‚¹</h3>
                    <ul>
                        <li>ä¸ä¾èµ– html2canvas</li>
                        <li>ä½¿ç”¨ SVG foreignObject</li>
                        <li>åŸç”Ÿ Canvas API</li>
                        <li>æ”¯æŒé«˜æ¸…è¾“å‡º</li>
                        <li>çµæ´»çš„æ°´å°ç³»ç»Ÿ</li>
                    </ul>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæµ·æŠ¥é¢„è§ˆ -->
            <div class="panel">
                <h2>ğŸ‘ï¸ æµ·æŠ¥é¢„è§ˆ</h2>
                
                <!-- åŸå§‹ DOM æµ·æŠ¥ -->
                <div id="posterContent">
                    <div id="posterImage">
                        <div style="font-size: 3em; opacity: 0.5;">ğŸ–¼ï¸</div>
                    </div>
                    <h1 id="posterTitle">åŸç”ŸæŠ€æœ¯å®ç°</h1>
                    <div id="posterSubtitle">DOM â†’ Canvas â†’ Image</div>
                    <div class="poster-footer">
                        <div>Made with â¤ï¸ by Native JavaScript</div>
                        <div style="margin-top: 10px;">No Dependencies Â· Pure Implementation</div>
                    </div>
                </div>

                <div class="tech-stack">
                    <h3>ğŸ”§ æŠ€æœ¯æ ˆ</h3>
                    <div class="tech-tags">
                        <span class="tech-tag">SVG</span>
                        <span class="tech-tag">Canvas API</span>
                        <span class="tech-tag">foreignObject</span>
                        <span class="tech-tag">XMLSerializer</span>
                        <span class="tech-tag">Data URL</span>
                    </div>
                </div>

                <!-- ç”Ÿæˆçš„å›¾ç‰‡é¢„è§ˆ -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">ç”Ÿæˆç»“æœ</h3>
                    <div id="previewArea">
                        <div style="text-align: center; color: #718096;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ¯</div>
                            <div>ç‚¹å‡»"ç”Ÿæˆæµ·æŠ¥"æŒ‰é’®æŸ¥çœ‹ç»“æœ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="dom-to-canvas.js"></script>
    <script>
        let generatedCanvas = null;

        /**
         * å®æ—¶æ›´æ–°æµ·æŠ¥å†…å®¹
         */
        function updatePoster() {
            const title = document.getElementById('titleInput').value;
            const subtitle = document.getElementById('subtitleInput').value;

            document.getElementById('posterTitle').textContent = title;
            document.getElementById('posterSubtitle').textContent = subtitle;
        }

        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
         */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MBï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;

                const posterImage = document.getElementById('posterImage');
                posterImage.innerHTML = '';
                posterImage.appendChild(img);
            };
            reader.readAsDataURL(file);
        }

        /**
         * ç”Ÿæˆæµ·æŠ¥ - ä½¿ç”¨åŸç”Ÿå®ç°
         */
        async function generatePoster() {
            const posterContent = document.getElementById('posterContent');
            const previewArea = document.getElementById('previewArea');
            const downloadBtn = document.getElementById('downloadBtn');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            previewArea.innerHTML = '<div class="loading">ğŸ¨ æ­£åœ¨ç”Ÿæˆæµ·æŠ¥...</div>';
            downloadBtn.disabled = true;

            try {
                const startTime = performance.now();

                // ä½¿ç”¨åŸç”Ÿæ–¹æ³•å°† DOM è½¬æ¢ä¸º Canvas
                let canvas = await domToCanvas(posterContent, {
                    scale: 2,                    // 2å€åˆ†è¾¨ç‡ï¼Œæé«˜æ¸…æ™°åº¦
                    backgroundColor: '#ffffff',   // ç™½è‰²èƒŒæ™¯
                    includeCss: true,            // åŒ…å« CSS æ ·å¼
                    quality: 1.0
                });

                // è·å–æ°´å°é…ç½®
                const watermarkType = document.getElementById('watermarkType').value;
                const watermarkText = document.getElementById('watermarkInput').value;
                const watermarkPosition = document.getElementById('watermarkPosition').value;

                // æ·»åŠ æ°´å°
                if (watermarkType === 'single' && watermarkText) {
                    canvas = addWatermarkToCanvas(canvas, watermarkText, {
                        fontSize: 20,
                        color: 'rgba(255, 255, 255, 0.3)',
                        rotation: -15,
                        position: watermarkPosition
                    });
                    console.log('âœ“ å·²æ·»åŠ å•ä¸ªæ°´å°');
                } else if (watermarkType === 'tiled' && watermarkText) {
                    canvas = addTiledWatermarkToCanvas(canvas, watermarkText, {
                        fontSize: 24,
                        color: 'rgba(255, 255, 255, 0.15)',
                        rotation: -30,
                        spacing: 200
                    });
                    console.log('âœ“ å·²æ·»åŠ å¹³é“ºæ°´å°');
                }

                // ä¿å­˜ç”Ÿæˆçš„ canvas
                generatedCanvas = canvas;

                // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶æ˜¾ç¤º
                const imgData = canvasToImage(canvas, 'image/png', 1.0);
                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                previewArea.innerHTML = `
                    <img src="${imgData}" alt="ç”Ÿæˆçš„æµ·æŠ¥" class="preview-image">
                    <div style="text-align: center; margin-top: 20px; color: #4a5568;">
                        <p style="font-size: 1.1em; font-weight: 600; color: #48bb78;">âœ… æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼</p>
                        <p style="margin-top: 10px;">åˆ†è¾¨ç‡: ${canvas.width} Ã— ${canvas.height}</p>
                        <p style="margin-top: 5px;">ç”Ÿæˆæ—¶é—´: ${duration}ç§’</p>
                        <p style="margin-top: 5px;">æ°´å°: ${watermarkType === 'none' ? 'æ— ' : watermarkType === 'single' ? 'å•ä¸ª' : 'å¹³é“º'}</p>
                        <p style="margin-top: 5px; font-weight: 600; color: #667eea;">ğŸ¯ çº¯åŸç”Ÿå®ç°ï¼Œæ— éœ€æ’ä»¶</p>
                    </div>
                `;

                // å¯ç”¨ä¸‹è½½æŒ‰é’®
                downloadBtn.disabled = false;

                console.log('âœ… æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼', {
                    width: canvas.width,
                    height: canvas.height,
                    duration: duration + 's',
                    size: Math.round(imgData.length / 1024) + ' KB'
                });

            } catch (error) {
                console.error('âŒ ç”Ÿæˆæµ·æŠ¥å¤±è´¥:', error);
                previewArea.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 15px;">âŒ</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">ç”Ÿæˆå¤±è´¥</div>
                        <div style="font-size: 0.9em;">${error.message}</div>
                    </div>
                `;
            }
        }

        /**
         * ä¸‹è½½ç”Ÿæˆçš„æµ·æŠ¥
         */
        async function downloadPoster() {
            if (!generatedCanvas) {
                alert('è¯·å…ˆç”Ÿæˆæµ·æŠ¥ï¼');
                return;
            }

            try {
                const timestamp = new Date().getTime();
                const filename = `poster-native-${timestamp}.png`;
                
                await downloadCanvas(generatedCanvas, filename, 'image/png', 1.0);
                
                console.log('âœ… æµ·æŠ¥ä¸‹è½½æˆåŠŸï¼');
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¨ åŸç”Ÿ DOM è½¬ Canvas æ¼”ç¤ºå·²åŠ è½½');
            console.log('ğŸ“¦ æŠ€æœ¯æ ˆ: SVG foreignObject + Canvas API');
            console.log('âœ¨ é›¶ä¾èµ–ï¼Œçº¯åŸç”Ÿå®ç°');
        });
    </script>
</body>
</html>

